<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>小羊抽奖系统（独家）</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3ECF8E',
                        secondary: '#10B981',
                        accent: '#F59E0B',
                        danger: '#EF4444'
                    }
                }
            }
        }
    </script>
    
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .btn-press {
                transform: scale(0.98);
            }
            .card-hover {
                transition: all 0.3s ease;
            }
            .card-hover:hover {
                transform: translateY(-5px);
                box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
            }
            .pulse-animation {
                animation: pulse 2s infinite;
            }
            @keyframes pulse {
                0% { transform: scale(1); }
                50% { transform: scale(1.05); }
                100% { transform: scale(1); }
            }
            .draw-animation {
                background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
                background-size: 200% 100%;
                animation: draw 1.5s infinite;
            }
            @keyframes draw {
                0% { background-position: 200% 0; }
                100% { background-position: -200% 0; }
            }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen font-sans">
    <!-- 加载中 -->
    <div id="loader" class="fixed inset-0 bg-white z-50 flex flex-col items-center justify-center">
        <div class="w-12 h-12 border-4 border-gray-200 border-t-primary rounded-full animate-spin mb-4"></div>
        <p id="loader-text" class="text-gray-600">加载中...</p>
    </div>

    <!-- 错误提示 -->
    <div id="error-container" class="fixed inset-0 bg-white z-50 flex flex-col items-center justify-center p-4 hidden">
        <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
            <i class="fa fa-exclamation-triangle text-2xl text-danger"></i>
        </div>
        <h3 class="text-xl font-bold text-gray-800 mb-2">初始化失败</h3>
        <p id="error-message" class="text-gray-600 text-center mb-6">无法连接到服务器，请稍后再试</p>
        <button id="retry-btn" class="px-6 py-2 bg-primary text-white rounded-lg font-medium hover:bg-primary/90 transition-all">
            重试
        </button>
    </div>

    <!-- 主容器 -->
    <div id="app" class="container mx-auto px-4 py-8 max-w-3xl hidden">
        <!-- 头部 -->
        <header class="text-center mb-8">
            <h1 class="text-[clamp(1.8rem,5vw,2.5rem)] font-bold text-gray-800 mb-2">小羊抽奖系统（独家）</h1>
            <p id="activity-status" class="inline-block px-4 py-1 rounded-full text-sm font-medium bg-primary/10 text-primary">
                加载中...
            </p>
        </header>

        <!-- 活动信息卡片 -->
        <div class="bg-white rounded-xl shadow-md p-6 mb-8 card-hover">
            <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                <i class="fa fa-info-circle text-primary mr-2"></i>活动详情
            </h2>
            <div id="activity-info" class="space-y-3 text-gray-600">
                <p><span class="font-medium text-gray-700">活动名称：</span><span id="activity-title">加载中...</span></p>
                <p><span class="font-medium text-gray-700">活动时间：</span><span id="activity-time">加载中...</span></p>
                <p><span class="font-medium text-gray-700">中奖人数：</span><span id="activity-winners">加载中...</span></p>
                <p><span class="font-medium text-gray-700">当前参与：</span><span id="participant-count">0</span>人</p>
            </div>
            
            <!-- 倒计时 -->
            <div id="countdown" class="mt-6 p-4 bg-gray-50 rounded-lg hidden">
                <p class="text-sm text-gray-500 mb-2">活动剩余时间</p>
                <div class="flex justify-center space-x-3">
                    <div class="text-center">
                        <div id="days" class="text-2xl font-bold text-primary">00</div>
                        <div class="text-xs text-gray-500">天</div>
                    </div>
                    <div class="text-center">
                        <div id="hours" class="text-2xl font-bold text-primary">00</div>
                        <div class="text-xs text-gray-500">时</div>
                    </div>
                    <div class="text-center">
                        <div id="minutes" class="text-2xl font-bold text-primary">00</div>
                        <div class="text-xs text-gray-500">分</div>
                    </div>
                    <div class="text-center">
                        <div id="seconds" class="text-2xl font-bold text-primary pulse-animation">00</div>
                        <div class="text-xs text-gray-500">秒</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 参与表单/结果展示 -->
        <div id="participate-section" class="bg-white rounded-xl shadow-md p-6 mb-8 card-hover">
            <!-- 参与表单（活动进行中且未参与） -->
            <div id="participate-form-container">
                <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                    <i class="fa fa-user-plus text-secondary mr-2"></i>参与抽奖
                </h2>
                <form id="participate-form" class="space-y-4">
                    <div>
                        <label for="blackbox-id" class="block text-sm font-medium text-gray-700 mb-1">小黑盒ID</label>
                        <input type="text" id="blackbox-id" placeholder="请输入您的小黑盒ID" 
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-colors"
                               required>
                    </div>
                    <button type="submit" id="submit-btn" 
                            class="w-full py-3 bg-primary text-white rounded-lg font-medium hover:bg-primary/90 transition-all active:btn-press flex items-center justify-center">
                        <i class="fa fa-gift mr-2"></i>确认参与
                    </button>
                </form>
            </div>

            <!-- 已参与提示 -->
            <div id="participated提示" class="text-center py-8 hidden">
                <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fa fa-check text-2xl text-secondary"></i>
                </div>
                <h3 class="text-lg font-medium text-gray-800 mb-2">您已成功参与抽奖</h3>
                <p class="text-gray-500">活动结束后将自动抽取幸运用户</p>
            </div>

            <!-- 活动未开始 -->
            <div id="not-started提示" class="text-center py-8 hidden">
                <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fa fa-clock-o text-2xl text-primary"></i>
                </div>
                <h3 class="text-lg font-medium text-gray-800 mb-2">活动尚未开始</h3>
                <p class="text-gray-500">请在活动开始时间后再来参与</p>
            </div>

            <!-- 活动已结束 -->
            <div id="ended提示" class="text-center py-8 hidden">
                <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fa fa-trophy text-2xl text-accent"></i>
                </div>
                <h3 class="text-lg font-medium text-gray-800 mb-4">活动已结束</h3>
                <button id="show-winners-btn" 
                        class="px-6 py-2 bg-gray-100 text-gray-800 rounded-lg font-medium hover:bg-gray-200 transition-all active:btn-press">
                    查看中奖名单
                </button>
            </div>
        </div>

        <!-- 管理员入口 -->
        <div class="text-center mb-8">
            <button id="admin-enter-btn" class="text-sm text-gray-500 hover:text-primary transition-colors">
                <i class="fa fa-lock mr-1"></i>管理员入口
            </button>
        </div>
    </div>

    <!-- 管理员登录模态框 -->
    <div id="admin-login-modal" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-xl p-6 max-w-md w-full">
            <h3 class="text-xl font-bold text-gray-800 mb-4">管理员登录</h3>
            <form id="admin-login-form" class="space-y-4">
                <div>
                    <label for="admin-password" class="block text-sm font-medium text-gray-700 mb-1">管理员密码</label>
                    <input type="password" id="admin-password" placeholder="请输入管理员密码" 
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-colors"
                           required>
                </div>
                <div class="flex space-x-3">
                    <button type="button" id="close-admin-modal" 
                            class="flex-1 py-2.5 bg-gray-100 text-gray-800 rounded-lg font-medium hover:bg-gray-200 transition-all active:btn-press">
                        取消
                    </button>
                    <button type="submit" 
                            class="flex-1 py-2.5 bg-primary text-white rounded-lg font-medium hover:bg-primary/90 transition-all active:btn-press">
                        登录
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- 管理员面板 -->
    <div id="admin-panel" class="fixed inset-0 bg-white z-50 hidden overflow-auto">
        <header class="bg-gray-800 text-white p-4 shadow-md">
            <div class="container mx-auto flex justify-between items-center">
                <h2 class="text-xl font-bold">小羊抽奖系统（独家）管理</h2>
                <button id="admin-logout" class="text-gray-300 hover:text-white transition-colors">
                    <i class="fa fa-sign-out mr-1"></i>退出
                </button>
            </div>
        </header>

        <main class="container mx-auto px-4 py-6">
            <!-- 活动设置 -->
            <div class="bg-white rounded-xl shadow-md p-6 mb-8 border border-gray-100">
                <h3 class="text-lg font-bold text-gray-800 mb-4">活动设置</h3>
                <form id="activity-form" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="activity-title-input" class="block text-sm font-medium text-gray-700 mb-1">活动名称</label>
                            <input type="text" id="activity-title-input" placeholder="输入活动名称" 
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-colors"
                                   required>
                        </div>
                        <div>
                            <label for="winner-count" class="block text-sm font-medium text-gray-700 mb-1">中奖人数</label>
                            <input type="number" id="winner-count" min="1" value="3" 
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-colors"
                                   required>
                        </div>
                        <div>
                            <label for="start-time" class="block text-sm font-medium text-gray-700 mb-1">开始时间</label>
                            <input type="datetime-local" id="start-time" 
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-colors"
                                   required>
                        </div>
                        <div>
                            <label for="end-time" class="block text-sm font-medium text-gray-700 mb-1">结束时间</label>
                            <input type="datetime-local" id="end-time" 
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-colors"
                                   required>
                        </div>
                    </div>
                    <div>
                        <label for="admin-password-set" class="block text-sm font-medium text-gray-700 mb-1">管理员密码（首次设置或修改）</label>
                        <input type="password" id="admin-password-set" placeholder="设置管理员密码" 
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-colors">
                    </div>
                    <button type="submit" 
                            class="py-2.5 px-6 bg-primary text-white rounded-lg font-medium hover:bg-primary/90 transition-all active:btn-press">
                        保存活动设置
                    </button>
                </form>
            </div>

            <!-- 活动控制 -->
            <div class="bg-white rounded-xl shadow-md p-6 mb-8 border border-gray-100">
                <h3 class="text-lg font-bold text-gray-800 mb-4">活动控制</h3>
                <div class="flex flex-wrap gap-3">
                    <button id="start-activity" 
                            class="py-2.5 px-6 bg-secondary text-white rounded-lg font-medium hover:bg-secondary/90 transition-all active:btn-press">
                        <i class="fa fa-play mr-1"></i>开启活动
                    </button>
                    <button id="end-activity" 
                            class="py-2.5 px-6 bg-danger text-white rounded-lg font-medium hover:bg-danger/90 transition-all active:btn-press">
                        <i class="fa fa-stop mr-1"></i>结束活动
                    </button>
                    <button id="copy-link" 
                            class="py-2.5 px-6 bg-gray-100 text-gray-800 rounded-lg font-medium hover:bg-gray-200 transition-all active:btn-press">
                        <i class="fa fa-link mr-1"></i>复制参与链接
                    </button>
                    <button id="clear-data" 
                            class="py-2.5 px-6 bg-gray-800 text-white rounded-lg font-medium hover:bg-gray-700 transition-all active:btn-press">
                        <i class="fa fa-trash mr-1"></i>清空数据
                    </button>
                </div>
                <!-- 移除手动抽奖按钮 -->
            </div>

            <!-- 参与者列表 -->
            <div class="bg-white rounded-xl shadow-md p-6 mb-8 border border-gray-100">
                <h3 class="text-lg font-bold text-gray-800 mb-4">参与者列表 (<span id="admin-participant-count">0</span>)</h3>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead>
                            <tr>
                                <th class="px-4 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">序号</th>
                                <th class="px-4 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">小黑盒ID</th>
                                <th class="px-4 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">IP地址</th>
                                <th class="px-4 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">参与时间</th>
                            </tr>
                        </thead>
                        <tbody id="participants-list" class="divide-y divide-gray-200">
                            <tr>
                                <td colspan="4" class="px-4 py-8 text-center text-gray-500">暂无参与者</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- 中奖名单 -->
            <div class="bg-white rounded-xl shadow-md p-6 mb-8 border border-gray-100">
                <h3 class="text-lg font-bold text-gray-800 mb-4">中奖名单</h3>
                <div id="winners-list" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="col-span-full text-center text-gray-500 py-8">
                        活动尚未结束或未抽奖
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- 中奖名单模态框 -->
    <div id="winners-modal" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-xl p-6 max-w-2xl w-full max-h-[80vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-800">中奖名单</h3>
                <button id="close-winners-modal" class="text-gray-500 hover:text-gray-700">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            <div id="public-winners-list" class="space-y-4">
                <div class="text-center text-gray-500 py-8">
                    暂无中奖信息
                </div>
            </div>
        </div>
    </div>

    <script>
        // Supabase配置
        const supabaseUrl = 'https://ordrnmjohtxjrwnigzml.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9yZHJubWpvaHR4anJ3bmlnem1sIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUyNTc2MDEsImV4cCI6MjA3MDgzMzYwMX0.OIvCWtQ3l3A3wSq8onLec3J_KG9KPRK8lJs7snqfhKE';
        
        // 初始化Supabase客户端
        let supabase;
        try {
            supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
        } catch (error) {
            showError("Supabase初始化失败，请检查配置信息");
        }

        // 全局数据
        let globalData = {
            activity: {
                id: 'default',
                title: "幸运抽奖活动",
                startTime: new Date().toISOString(),
                endTime: new Date(Date.now() + 86400000).toISOString(), // 24小时后结束
                winnerCount: 3,
                status: "pending", // pending: 未开始, active: 进行中, ended: 已结束
                password: "" // 管理员密码哈希
            },
            participants: [],
            winners: [],
            isAdmin: false,
            userIp: "",
            subscriptions: [], // 存储实时订阅
            isSubmitting: false, // 标记是否正在提交中
            isAutoDrawing: false // 标记是否正在自动抽奖中
        };

        // 显示错误信息
        function showError(message) {
            document.getElementById("loader").classList.add("hidden");
            document.getElementById("app").classList.add("hidden");
            document.getElementById("error-container").classList.remove("hidden");
            document.getElementById("error-message").textContent = message;
        }

        // 更新加载状态文本
        function updateLoaderText(text) {
            document.getElementById("loader-text").textContent = text;
        }

        // 初始化应用
        async function initApp() {
            try {
                if (!supabase) {
                    throw new Error("Supabase客户端未初始化");
                }
                
                updateLoaderText("正在检查数据库连接...");
                
                // 检查Supabase连接和表是否存在
                const { error: connectionError } = await supabase.from('activity').select('count', { count: 'exact', head: true });
                if (connectionError) {
                    if (connectionError.code === 'PGRST116') {
                        // 表不存在，提示创建表
                        showError(`数据库表不存在，请先在Supabase中执行创建表的SQL脚本。错误详情：${connectionError.message}`);
                        return;
                    } else {
                        throw new Error(`数据库连接失败: ${connectionError.message}`);
                    }
                }
                
                updateLoaderText("正在获取用户信息...");
                // 获取用户IP（用于防重复参与）
                await getUserIp();
                
                updateLoaderText("正在加载活动数据...");
                // 加载数据
                await loadActivityData();
                
                updateLoaderText("正在加载参与者...");
                await loadParticipants();
                
                updateLoaderText("正在加载中奖信息...");
                await loadWinners();
                
                updateLoaderText("正在设置实时同步...");
                // 设置实时订阅
                setupRealtimeSubscriptions();
                
                // 检查是否需要自动抽奖（活动已结束但未抽奖）
                checkAndAutoDraw();
                
                // 手动刷新UI状态
                updateActivityDisplay();
                
                updateLoaderText("准备就绪...");
                // 隐藏加载动画，显示应用
                setTimeout(() => {
                    document.getElementById("loader").classList.add("hidden");
                    document.getElementById("app").classList.remove("hidden");
                }, 500);
                
            } catch (error) {
                console.error("初始化错误:", error);
                showError(error.message || "初始化失败，请检查网络连接和配置");
            }
        }

        // 获取用户IP
        function getUserIp() {
            return new Promise((resolve) => {
                // 尝试从本地存储获取
                const savedIp = localStorage.getItem("lottery_user_ip");
                if (savedIp) {
                    globalData.userIp = savedIp;
                    resolve();
                    return;
                }
                
                // 从API获取，失败时使用临时ID
                fetch("https://api.ipify.org?format=json")
                    .then(response => response.json().catch(() => null))
                    .then(data => {
                        if (data?.ip) {
                            globalData.userIp = data.ip;
                            localStorage.setItem("lottery_user_ip", data.ip);
                        } else {
                            // 失败时生成临时ID
                            const tempId = "temp_" + Math.random().toString(36).substr(2, 9);
                            globalData.userIp = tempId;
                            localStorage.setItem("lottery_user_ip", tempId);
                        }
                        resolve();
                    })
                    .catch(() => {
                        // 网络错误时生成临时ID
                        const tempId = "temp_" + Math.random().toString(36).substr(2, 9);
                        globalData.userIp = tempId;
                        localStorage.setItem("lottery_user_ip", tempId);
                        resolve();
                    });
            });
        }

        // 加载活动数据
        async function loadActivityData() {
            try {
                const { data, error } = await supabase
                    .from('activity')
                    .select('*')
                    .eq('id', 'default')
                    .single();
                    
                if (error) {
                    if (error.code === 'PGRST116') {
                        // 表中没有数据，插入默认活动
                        const { error: insertError } = await supabase
                            .from('activity')
                            .insert([{
                                id: 'default',
                                title: "小羊抽奖活动",
                                start_time: new Date().toISOString(),
                                end_time: new Date(Date.now() + 86400000).toISOString(),
                                winner_count: 3,
                                status: "pending",
                                password: ""
                            }]);
                            
                        if (insertError) throw insertError;
                    } else {
                        throw error;
                    }
                } else {
                    // 映射蛇形命名字段到驼峰变量
                    globalData.activity = {
                        ...data,
                        startTime: data.start_time,
                        endTime: data.end_time,
                        winnerCount: data.winner_count
                    };
                }
                
                updateActivityDisplay();
            } catch (error) {
                console.error("加载活动数据错误:", error);
                throw new Error(`加载活动信息失败: ${error.message}`);
            }
        }

        // 加载参与者数据
        async function loadParticipants() {
            try {
                const { data, error } = await supabase
                    .from('participants')
                    .select('*')
                    .order('time', { ascending: false });
                    
                if (error) throw error;
                
                globalData.participants = data || [];
                updateParticipantsDisplay();
            } catch (error) {
                console.error("加载参与者错误:", error);
                throw new Error(`加载参与者信息失败: ${error.message}`);
            }
        }

        // 检查IP是否已参与
        async function checkIpParticipated(ip) {
            try {
                const { count, error } = await supabase
                    .from('participants')
                    .select('*', { count: 'exact', head: true })
                    .eq('ip', ip);
                    
                if (error) throw error;
                
                return count > 0;
            } catch (error) {
                console.error("检查IP参与状态错误:", error);
                return false;
            }
        }

        // 加载中奖者数据
        async function loadWinners() {
            try {
                const { data, error } = await supabase
                    .from('winners')
                    .select('*')
                    .order('rank', { ascending: true });
                    
                if (error) throw error;
                
                globalData.winners = data || [];
                updateWinnersDisplay();
            } catch (error) {
                console.error("加载中奖者错误:", error);
                throw new Error(`加载中奖信息失败: ${error.message}`);
            }
        }

        // 设置实时订阅
        function setupRealtimeSubscriptions() {
            // 清除之前的订阅
            globalData.subscriptions.forEach(channel => {
                supabase.removeChannel(channel);
            });
            globalData.subscriptions = [];
            
            try {
                // 订阅活动数据变化
                const activityChannel = supabase
                    .channel('activity-channel')
                    .on(
                        'postgres_changes',
                        { event: '*', schema: 'public', table: 'activity' },
                        (payload) => {
                            if (payload.new) {
                                globalData.activity = {
                                    ...payload.new,
                                    startTime: payload.new.start_time,
                                    endTime: payload.new.end_time,
                                    winnerCount: payload.new.winner_count
                                };
                                updateActivityDisplay();
                                // 检查是否需要自动抽奖
                                checkAndAutoDraw();
                            }
                        }
                    )
                    .subscribe();
                
                globalData.subscriptions.push(activityChannel);
                
                // 订阅参与者数据变化
                const participantsChannel = supabase
                    .channel('participants-channel')
                    .on(
                        'postgres_changes',
                        { event: '*', schema: 'public', table: 'participants' },
                        () => {
                            loadParticipants();
                        }
                    )
                    .subscribe();
                
                globalData.subscriptions.push(participantsChannel);
                
                // 订阅中奖者数据变化
                const winnersChannel = supabase
                    .channel('winners-channel')
                    .on(
                        'postgres_changes',
                        { event: '*', schema: 'public', table: 'winners' },
                        () => {
                            loadWinners();
                        }
                    )
                    .subscribe();
                
                globalData.subscriptions.push(winnersChannel);
            } catch (error) {
                console.error("设置实时订阅错误:", error);
                alert("实时通知功能可能无法使用，数据可能不会自动更新");
            }
        }

        // 更新活动显示
        function updateActivityDisplay() {
            const { title, startTime, endTime, winnerCount, status } = globalData.activity;
            
            // 格式化时间
            const start = new Date(startTime);
            const end = new Date(endTime);
            const formattedStart = start.toLocaleString();
            const formattedEnd = end.toLocaleString();
            
            // 更新活动信息
            document.getElementById("activity-title").textContent = title;
            document.getElementById("activity-time").textContent = `${formattedStart} - ${formattedEnd}`;
            document.getElementById("activity-winners").textContent = `${winnerCount}人`;
            document.getElementById("participant-count").textContent = globalData.participants.length;
            document.getElementById("admin-participant-count").textContent = globalData.participants.length;
            
            // 更新活动状态标签
            const statusEl = document.getElementById("activity-status");
            switch(status) {
                case "pending":
                    statusEl.textContent = "未开始";
                    statusEl.className = "inline-block px-4 py-1 rounded-full text-sm font-medium bg-blue-100 text-blue-800";
                    break;
                case "active":
                    statusEl.textContent = "进行中";
                    statusEl.className = "inline-block px-4 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800";
                    break;
                case "ended":
                    statusEl.textContent = "已结束";
                    statusEl.className = "inline-block px-4 py-1 rounded-full text-sm font-medium bg-gray-100 text-gray-800";
                    break;
            }
            
            // 控制倒计时显示
            const now = new Date();
            const countdownEl = document.getElementById("countdown");
            
            if (status === "active" && now < end) {
                countdownEl.classList.remove("hidden");
                startCountdown(end);
            } else {
                countdownEl.classList.add("hidden");
            }
            
            // 控制参与表单显示
            const hasParticipated = globalData.participants.some(p => p.ip === globalData.userIp);
            const formContainer = document.getElementById("participate-form-container");
            const participated提示 = document.getElementById("participated提示");
            const notStarted提示 = document.getElementById("not-started提示");
            const ended提示 = document.getElementById("ended提示");
            
            formContainer.classList.add("hidden");
            participated提示.classList.add("hidden");
            notStarted提示.classList.add("hidden");
            ended提示.classList.add("hidden");
            
            if (status === "active") {
                if (hasParticipated) {
                    participated提示.classList.remove("hidden");
                } else {
                    formContainer.classList.remove("hidden");
                }
            } else if (status === "pending") {
                notStarted提示.classList.remove("hidden");
            } else if (status === "ended") {
                ended提示.classList.remove("hidden");
            }
            
            // 更新管理员表单
            document.getElementById("activity-title-input").value = title;
            document.getElementById("winner-count").value = winnerCount;
            document.getElementById("start-time").value = formatDateTimeForInput(start);
            document.getElementById("end-time").value = formatDateTimeForInput(end);
        }

        // 更新参与者显示
        function updateParticipantsDisplay() {
            const listEl = document.getElementById("participants-list");
            
            if (globalData.participants.length === 0) {
                listEl.innerHTML = `
                    <tr>
                        <td colspan="4" class="px-4 py-8 text-center text-gray-500">暂无参与者</td>
                    </tr>
                `;
                return;
            }
            
            listEl.innerHTML = globalData.participants.map((p, index) => `
                <tr class="hover:bg-gray-50">
                    <td class="px-4 py-3">${index + 1}</td>
                    <td class="px-4 py-3">${p.name}</td>
                    <td class="px-4 py-3 text-sm text-gray-500">${p.ip}</td>
                    <td class="px-4 py-3 text-sm text-gray-500">${new Date(p.time).toLocaleString()}</td>
                </tr>
            `).join("");
        }

        // 更新中奖者显示
        function updateWinnersDisplay() {
            const adminListEl = document.getElementById("winners-list");
            const publicListEl = document.getElementById("public-winners-list");
            
            if (globalData.winners.length === 0) {
                adminListEl.innerHTML = `
                    <div class="col-span-full text-center text-gray-500 py-8">
                        活动尚未结束或未抽奖
                    </div>
                `;
                publicListEl.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        暂无中奖信息
                    </div>
                `;
                return;
            }
            
            // 管理员页面显示
            adminListEl.innerHTML = globalData.winners.map((winner) => `
                <div class="bg-gray-50 p-4 rounded-lg border border-gray-100">
                    <div class="flex justify-between items-start mb-2">
                        <span class="font-medium ${
                            winner.rank === 1 ? 'text-yellow-600' : 
                            winner.rank === 2 ? 'text-gray-400' : 
                            winner.rank === 3 ? 'text-amber-700' : 'text-gray-700'
                        }">
                            ${winner.rank}${winner.rank < 4 ? ['等奖', '等奖', '等奖'][winner.rank - 1] : '名'}
                        </span>
                        <span class="text-xs text-gray-500">
                            ${new Date(winner.time).toLocaleString()}
                        </span>
                    </div>
                    <div class="text-gray-800 font-medium">${winner.name}</div>
                </div>
            `).join("");
            
            // 公共页面显示
            publicListEl.innerHTML = globalData.winners.map((winner) => `
                <div class="border border-gray-100 rounded-lg p-4">
                    <div class="flex justify-between items-center mb-2">
                        <span class="font-medium ${
                            winner.rank === 1 ? 'text-yellow-600' : 
                            winner.rank === 2 ? 'text-gray-400' : 
                            winner.rank === 3 ? 'text-amber-700' : 'text-gray-700'
                        }">
                            ${winner.rank}${winner.rank < 4 ? ['等奖', '等奖', '等奖'][winner.rank - 1] : '名'}
                        </span>
                    </div>
                    <div class="text-gray-800">${winner.name}</div>
                </div>
            `).join("");
        }

        // 启动倒计时
        function startCountdown(endTime) {
            // 清除之前的定时器
            if (window.countdownTimer) {
                clearInterval(window.countdownTimer);
            }
            
            function updateCountdown() {
                const now = new Date().getTime();
                const distance = endTime - now;
                
                if (distance <= 0) {
                    // 时间到，自动结束活动
                    if (globalData.activity.status === "active") {
                        updateActivityStatus("ended");
                    }
                    clearInterval(window.countdownTimer);
                    return;
                }
                
                const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((distance % (1000 * 60)) / 1000);
                
                document.getElementById("days").textContent = days.toString().padStart(2, "0");
                document.getElementById("hours").textContent = hours.toString().padStart(2, "0");
                document.getElementById("minutes").textContent = minutes.toString().padStart(2, "0");
                document.getElementById("seconds").textContent = seconds.toString().padStart(2, "0");
            }
            
            // 立即更新一次
            updateCountdown();
            // 每秒更新一次
            window.countdownTimer = setInterval(updateCountdown, 1000);
        }

        // 更新活动状态
        async function updateActivityStatus(status) {
            try {
                const { error } = await supabase
                    .from('activity')
                    .update({ status })
                    .eq('id', 'default');
                    
                if (error) {
                    throw new Error(error.message);
                }
                
                // 立即更新本地状态并刷新UI
                globalData.activity.status = status;
                updateActivityDisplay();
                
                // 如果活动状态变为结束，检查是否需要自动抽奖
                if (status === "ended") {
                    checkAndAutoDraw();
                }
            } catch (error) {
                alert("更新活动状态失败: " + error.message);
            }
        }

        // 检查并执行自动抽奖
        async function checkAndAutoDraw() {
            // 条件：活动已结束 + 没有中奖名单 + 参与人数足够 + 不在抽奖中
            if (globalData.activity.status === "ended" && 
                globalData.winners.length === 0 && 
                globalData.participants.length >= globalData.activity.winnerCount &&
                !globalData.isAutoDrawing) {
                
                globalData.isAutoDrawing = true;
                
                try {
                    // 显示自动抽奖中提示（仅管理员可见）
                    const winnersList = document.getElementById("winners-list");
                    winnersList.innerHTML = `
                        <div class="col-span-full text-center py-12">
                            <div class="w-16 h-16 border-4 border-gray-200 border-t-accent rounded-full animate-spin mx-auto mb-4"></div>
                            <p class="text-gray-600">活动已结束，正在自动抽取幸运用户...</p>
                        </div>
                    `;
                    
                    // 随机抽取获奖者（不重复）
                    const shuffled = [...globalData.participants].sort(() => 0.5 - Math.random());
                    const winners = shuffled.slice(0, globalData.activity.winnerCount);
                    
                    // 添加排名并保存到数据库
                    const winnersWithRank = winners.map((winner, index) => ({
                        name: winner.name,
                        ip: winner.ip,
                        time: new Date().toISOString(),
                        rank: index + 1
                    }));
                    
                    // 模拟抽奖过程延迟
                    await new Promise(resolve => setTimeout(resolve, 3000));
                    
                    const { error } = await supabase
                        .from('winners')
                        .insert(winnersWithRank);
                        
                    if (error) {
                        throw new Error(error.message);
                    }
                    
                    // 刷新中奖名单
                    await loadWinners();
                    
                } catch (error) {
                    console.error("自动抽奖失败:", error);
                    const winnersList = document.getElementById("winners-list");
                    winnersList.innerHTML = `
                        <div class="col-span-full text-center text-red-500 py-8">
                            <i class="fa fa-exclamation-circle text-2xl mb-2"></i>
                            <p>自动抽奖失败，请稍后手动处理</p>
                        </div>
                    `;
                } finally {
                    globalData.isAutoDrawing = false;
                }
            }
        }

        // 绑定所有事件
        function bindEvents() {
            // 重试按钮
            document.getElementById("retry-btn").addEventListener("click", () => {
                document.getElementById("error-container").classList.add("hidden");
                document.getElementById("loader").classList.remove("hidden");
                initApp();
            });
            
            // 参与表单提交
            document.getElementById("participate-form").addEventListener("submit", async (e) => {
                e.preventDefault();
                
                // 检查是否正在提交中
                if (globalData.isSubmitting) {
                    return;
                }
                
                const blackboxId = document.getElementById("blackbox-id").value.trim();
                const submitBtn = document.getElementById("submit-btn");
                
                if (!blackboxId) {
                    alert("请输入小黑盒ID");
                    return;
                }
                
                // 检查活动状态
                if (globalData.activity.status !== "active") {
                    alert("活动未开始或已结束");
                    return;
                }
                
                try {
                    // 设置提交状态
                    globalData.isSubmitting = true;
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '<i class="fa fa-spinner fa-spin mr-2"></i>提交中...';
                    submitBtn.classList.add("opacity-70", "cursor-not-allowed");
                    
                    // 检查IP是否已参与
                    const hasParticipated = await checkIpParticipated(globalData.userIp);
                    if (hasParticipated) {
                        alert("您已参与过本次活动");
                        return;
                    }
                    
                    // 添加参与者
                    const { error } = await supabase
                        .from('participants')
                        .insert([{
                            name: blackboxId,
                            ip: globalData.userIp,
                            time: new Date().toISOString()
                        }]);
                        
                    if (error) {
                        throw new Error(error.message);
                    }
                    
                    alert("参与成功！");
                    document.getElementById("participate-form").reset();
                } catch (error) {
                    alert("参与失败: " + error.message);
                } finally {
                    // 恢复提交状态
                    globalData.isSubmitting = false;
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i class="fa fa-gift mr-2"></i>确认参与';
                    submitBtn.classList.remove("opacity-70", "cursor-not-allowed");
                }
            });
            
            // 管理员入口
            document.getElementById("admin-enter-btn").addEventListener("click", () => {
                document.getElementById("admin-login-modal").classList.remove("hidden");
                document.getElementById("admin-login-modal").classList.add("flex");
            });
            
            // 关闭管理员模态框
            document.getElementById("close-admin-modal").addEventListener("click", () => {
                document.getElementById("admin-login-modal").classList.add("hidden");
                document.getElementById("admin-login-modal").classList.remove("flex");
            });
            
            // 管理员登录
            document.getElementById("admin-login-form").addEventListener("submit", (e) => {
                e.preventDefault();
                
                const password = document.getElementById("admin-password").value;
                const passwordHash = btoa(password); // 简单加密
                
                if (passwordHash === globalData.activity.password || 
                    (globalData.activity.password === "" && password === "admin123")) { // 首次登录默认密码
                    // 登录成功
                    globalData.isAdmin = true;
                    document.getElementById("admin-login-modal").classList.add("hidden");
                    document.getElementById("admin-login-modal").classList.remove("flex");
                    document.getElementById("admin-panel").classList.remove("hidden");
                    
                    // 首次登录且未设置密码，自动设置
                    if (globalData.activity.password === "") {
                        updateAdminPassword(passwordHash);
                    }
                } else {
                    alert("密码错误");
                }
            });
            
            // 管理员登出
            document.getElementById("admin-logout").addEventListener("click", () => {
                globalData.isAdmin = false;
                document.getElementById("admin-panel").classList.add("hidden");
            });
            
            // 活动设置表单提交
            document.getElementById("activity-form").addEventListener("submit", async (e) => {
                e.preventDefault();
                
                const title = document.getElementById("activity-title-input").value.trim();
                const winnerCount = parseInt(document.getElementById("winner-count").value);
                const startTime = document.getElementById("start-time").value;
                const endTime = document.getElementById("end-time").value;
                const newPassword = document.getElementById("admin-password-set").value;
                
                if (!title) {
                    alert("请输入活动名称");
                    return;
                }
                
                if (isNaN(winnerCount) || winnerCount < 1) {
                    alert("请输入有效的中奖人数");
                    return;
                }
                
                if (!startTime || !endTime) {
                    alert("请选择活动时间");
                    return;
                }
                
                if (new Date(startTime) >= new Date(endTime)) {
                    alert("结束时间必须晚于开始时间");
                    return;
                }
                
                try {
                    // 准备更新数据
                    const updates = {
                        title,
                        start_time: startTime,
                        end_time: endTime,
                        winner_count: winnerCount
                    };
                    
                    // 如果输入了新密码，则更新
                    if (newPassword) {
                        updates.password = btoa(newPassword);
                    }
                    
                    const { error } = await supabase
                        .from('activity')
                        .update(updates)
                        .eq('id', 'default');
                        
                    if (error) {
                        throw new Error(error.message);
                    }
                    
                    alert("活动设置已保存");
                    if (newPassword) {
                        document.getElementById("admin-password-set").value = "";
                    }
                } catch (error) {
                    alert("保存失败: " + error.message);
                }
            });
            
            // 开启活动
            document.getElementById("start-activity").addEventListener("click", async () => {
                if (globalData.activity.status === "active") {
                    alert("活动已在进行中");
                    return;
                }
                
                const now = new Date();
                const startTime = new Date(globalData.activity.startTime);
                
                if (now < startTime) {
                    if (!confirm("活动开始时间尚未到达，确定要提前开启吗？")) {
                        return;
                    }
                }
                
                await updateActivityStatus("active");
                alert("活动已开启");
            });
            
            // 结束活动
            document.getElementById("end-activity").addEventListener("click", async () => {
                if (globalData.activity.status !== "active") {
                    alert("活动未在进行中");
                    return;
                }
                
                if (!confirm("确定要结束活动吗？结束后系统将自动抽奖")) {
                    return;
                }
                
                await updateActivityStatus("ended");
                alert("活动已结束，系统将自动进行抽奖");
            });
            
            // 复制参与链接
            document.getElementById("copy-link").addEventListener("click", () => {
                const link = window.location.href;
                navigator.clipboard.writeText(link)
                    .then(() => alert("链接已复制"))
                    .catch(() => {
                        prompt("请复制链接", link);
                    });
            });
            
            // 清空数据
            document.getElementById("clear-data").addEventListener("click", async () => {
                if (!confirm("确定要清空所有参与者和中奖者数据吗？此操作不可恢复！")) {
                    return;
                }
                
                try {
                    // 先删除中奖者
                    const { error: winnersError } = await supabase
                        .from('winners')
                        .delete()
                        .neq('id', '');
                        
                    if (winnersError) {
                        throw new Error(winnersError.message);
                    }
                    
                    // 再删除参与者
                    const { error: participantsError } = await supabase
                        .from('participants')
                        .delete()
                        .neq('id', '');
                        
                    if (participantsError) {
                        throw new Error(participantsError.message);
                    }
                    
                    alert("数据已清空");
                } catch (error) {
                    alert("清空失败: " + error.message);
                }
            });
            
            // 查看中奖名单
            document.getElementById("show-winners-btn").addEventListener("click", () => {
                document.getElementById("winners-modal").classList.remove("hidden");
                document.getElementById("winners-modal").classList.add("flex");
            });
            
            // 关闭中奖名单模态框
            document.getElementById("close-winners-modal").addEventListener("click", () => {
                document.getElementById("winners-modal").classList.add("hidden");
                document.getElementById("winners-modal").classList.remove("flex");
            });
        }

        // 更新管理员密码
        async function updateAdminPassword(passwordHash) {
            try {
                const { error } = await supabase
                    .from('activity')
                    .update({ password: passwordHash })
                    .eq('id', 'default');
                    
                if (error) {
                    throw new Error(error.message);
                }
            } catch (error) {
                console.error("更新密码失败: ", error);
                alert("更新管理员密码失败，请手动设置");
            }
        }

        // 格式化日期为input所需格式
        function formatDateTimeForInput(date) {
            return date.toISOString().slice(0, 16);
        }

        // 页面加载完成后初始化
        window.addEventListener("DOMContentLoaded", () => {
            // 绑定事件
            bindEvents();
            // 初始化应用
            initApp();
        });

        // 页面关闭时清理
        window.addEventListener("beforeunload", () => {
            // 清除定时器
            if (window.countdownTimer) {
                clearInterval(window.countdownTimer);
            }
            
            // 清除订阅
            globalData.subscriptions.forEach(channel => {
                if (supabase) {
                    supabase.removeChannel(channel);
                }
            });
        });
    </script>
</body>
</html>
    
