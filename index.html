<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>小羊抽奖系统（独家）</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3ECF8E',
                        secondary: '#10B981',
                        accent: '#F59E0B',
                        danger: '#EF4444'
                    }
                }
            }
        }
    </script>
    
    <style type="text/tailwindcss">
        @layer utilities {
        /* 新增发布动画样式 */
    .publish-overlay {
        animation: fadeIn 0.3s ease-out;
    }
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
            .content-auto {
                content-visibility: auto;
            }
            .btn-press {
                transform: scale(0.98);
            }
            .card-hover {
                transition: all 0.3s ease;
            }
            .card-hover:hover {
                transform: translateY(-5px);
                box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
            }
            .pulse-animation {
                animation: pulse 2s infinite;
            }
            .marquee {
                animation: marquee 30s linear infinite;
            }
            @keyframes pulse {
                0% { transform: scale(1); }
                50% { transform: scale(1.05); }
                100% { transform: scale(1); }
            }
            @keyframes marquee {
                0% { transform: translateX(100%); }
                100% { transform: translateX(-100%); }
            }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen font-sans">
    <!-- 滚动弹幕 -->
    <div class="bg-primary/90 text-white py-2 overflow-hidden whitespace-nowrap">
        <div id="marquee-content" class="marquee inline-block">
            欢迎参与小羊抽奖活动！祝大家好运连连，大奖不断！
        </div>
    </div>

    <!-- 加载中 -->
    <div id="loader" class="fixed inset-0 bg-white z-50 flex flex-col items-center justify-center">
        <div class="w-12 h-12 border-4 border-gray-200 border-t-primary rounded-full animate-spin mb-4"></div>
        <p id="loader-text" class="text-gray-600">加载中...</p>
    </div>

    <!-- 错误提示 -->
    <div id="error-container" class="fixed inset-0 bg-white z-50 flex flex-col items-center justify-center p-4 hidden">
        <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
            <i class="fa fa-exclamation-triangle text-2xl text-danger"></i>
        </div>
        <h3 class="text-xl font-bold text-gray-800 mb-2">初始化失败</h3>
        <p id="error-message" class="text-gray-600 text-center mb-6">无法连接到服务器，请稍后再试</p>
        <button id="retry-btn" class="px-6 py-2 bg-primary text-white rounded-lg font-medium hover:bg-primary/90 transition-all">
            重试
        </button>
    </div>

    <!-- 主容器 -->
    <div id="app" class="container mx-auto px-4 py-8 max-w-3xl hidden">
        <!-- 头部 -->
        <header class="text-center mb-8">
            <h1 class="text-[clamp(1.8rem,5vw,2.5rem)] font-bold text-gray-800 mb-2">小羊抽奖系统（独家）</h1>
            <p id="activity-status" class="inline-block px-4 py-1 rounded-full text-sm font-medium bg-primary/10 text-primary">
                加载中...
            </p>
        </header>

        <!-- 历史活动展示 -->
        <div id="history-activity" class="bg-white rounded-xl shadow-md p-6 mb-8 card-hover hidden">
            <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                <i class="fa fa-history text-gray-500 mr-2"></i>上一期活动中奖名单
            </h2>
            <div id="history-winners-list" class="space-y-4">
                <div class="text-center text-gray-500 py-6">
                    暂无历史活动信息
                </div>
            </div>
        </div>

        <!-- 活动信息卡片 -->
        <div class="bg-white rounded-xl shadow-md p-6 mb-8 card-hover">
            <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                <i class="fa fa-info-circle text-primary mr-2"></i>本期活动详情
            </h2>
            <div id="activity-info" class="space-y-3 text-gray-600">
                <p><span class="font-medium text-gray-700">活动名称：</span><span id="activity-title">加载中...</span></p>
                <p><span class="font-medium text-gray-700">活动时间：</span><span id="activity-time">加载中...</span></p>
                <p><span class="font-medium text-gray-700">活动时长：</span><span id="activity-duration">加载中...</span></p>
                <p><span class="font-medium text-gray-700">中奖人数：</span><span id="activity-winners">加载中...</span></p>
                <p><span class="font-medium text-gray-700">当前参与：</span><span id="participant-count">0</span>人</p>
            </div>
            
            <!-- 倒计时 -->
            <div id="countdown" class="mt-6 p-4 bg-gray-50 rounded-lg hidden">
                <p class="text-sm text-gray-500 mb-2">活动剩余时间</p>
                <div class="flex justify-center space-x-3">
                    <div class="text-center">
                        <div id="days" class="text-2xl font-bold text-primary">00</div>
                        <div class="text-xs text-gray-500">天</div>
                    </div>
                    <div class="text-center">
                        <div id="hours" class="text-2xl font-bold text-primary">00</div>
                        <div class="text-xs text-gray-500">时</div>
                    </div>
                    <div class="text-center">
                        <div id="minutes" class="text-2xl font-bold text-primary">00</div>
                        <div class="text-xs text-gray-500">分</div>
                    </div>
                    <div class="text-center">
                        <div id="seconds" class="text-2xl font-bold text-primary pulse-animation">00</div>
                        <div class="text-xs text-gray-500">秒</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 参与表单/结果展示 -->
        <div id="participate-section" class="bg-white rounded-xl shadow-md p-6 mb-8 card-hover">
            <!-- 参与表单（活动进行中且未参与） -->
            <div id="participate-form-container">
                <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                    <i class="fa fa-user-plus text-secondary mr-2"></i>参与抽奖
                </h2>
                <form id="participate-form" class="space-y-4">
                    <div>
                        <label for="blackbox-id" class="block text-sm font-medium text-gray-700 mb-1">小黑盒ID</label>
                        <input type="text" id="blackbox-id" placeholder="请输入您的小黑盒ID" 
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-colors"
                               required>
                    </div>
                    <button type="submit" id="submit-btn" 
                            class="w-full py-3 bg-primary text-white rounded-lg font-medium hover:bg-primary/90 transition-all active:btn-press flex items-center justify-center">
                        <i class="fa fa-gift mr-2"></i>确认参与
                    </button>
                </form>
            </div>

            <!-- 已参与提示 -->
            <div id="participated提示" class="text-center py-8 hidden">
                <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fa fa-check text-2xl text-secondary"></i>
                </div>
                <h3 class="text-lg font-medium text-gray-800 mb-2">您已成功参与抽奖</h3>
                <p class="text-gray-500">活动结束后将自动抽取幸运用户</p>
            </div>

            <!-- 活动未开始 -->
            <div id="not-started提示" class="text-center py-8 hidden">
                <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fa fa-clock-o text-2xl text-primary"></i>
                </div>
                <h3 class="text-lg font-medium text-gray-800 mb-2">活动尚未开始</h3>
                <p class="text-gray-500">请在活动开始时间后再来参与</p>
            </div>

            <!-- 活动已结束 -->
            <div id="ended提示" class="text-center py-8 hidden">
                <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fa fa-trophy text-2xl text-accent"></i>
                </div>
                <h3 class="text-lg font-medium text-gray-800 mb-4">活动已结束</h3>
                <button id="show-winners-btn" 
                        class="px-6 py-2 bg-gray-100 text-gray-800 rounded-lg font-medium hover:bg-gray-200 transition-all active:btn-press">
                    查看本期中奖名单
                </button>
            </div>
        </div>

        <!-- 管理员入口 -->
        <div class="text-center mb-8">
            <button id="admin-enter-btn" class="text-sm text-gray-500 hover:text-primary transition-colors">
                <i class="fa fa-lock mr-1"></i>管理员入口
            </button>
        </div>
    </div>

    <!-- 管理员登录模态框 -->
    <div id="admin-login-modal" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-xl p-6 max-w-md w-full">
            <h3 class="text-xl font-bold text-gray-800 mb-4">管理员登录</h3>
            <form id="admin-login-form" class="space-y-4">
                <div>
                    <label for="admin-password" class="block text-sm font-medium text-gray-700 mb-1">管理员密码</label>
                    <input type="password" id="admin-password" placeholder="请输入管理员密码" 
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-colors"
                           required>
                </div>
                <div class="flex space-x-3">
                    <button type="button" id="close-admin-modal" 
                            class="flex-1 py-2.5 bg-gray-100 text-gray-800 rounded-lg font-medium hover:bg-gray-200 transition-all active:btn-press">
                        取消
                    </button>
                    <button type="submit" 
                            class="flex-1 py-2.5 bg-primary text-white rounded-lg font-medium hover:bg-primary/90 transition-all active:btn-press">
                        登录
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- 管理员面板 -->
    <div id="admin-panel" class="fixed inset-0 bg-white z-50 hidden overflow-auto">
        <header class="bg-gray-800 text-white p-4 shadow-md">
            <div class="container mx-auto flex justify-between items-center">
                <h2 class="text-xl font-bold">小羊抽奖系统（独家）管理员面板</h2>
                <button id="admin-logout" class="text-gray-300 hover:text-white transition-colors">
                    <i class="fa fa-sign-out mr-1"></i>退出
                </button>
            </div>
        </header>

        <main class="container mx-auto px-4 py-6">
            <!-- 弹幕设置 -->
            <div class="bg-white rounded-xl shadow-md p-6 mb-8 border border-gray-100">
                <h3 class="text-lg font-bold text-gray-800 mb-4">滚动弹幕设置</h3>
                <form id="marquee-form" class="space-y-4">
                    <div>
                        <label for="marquee-text" class="block text-sm font-medium text-gray-700 mb-1">弹幕内容</label>
                        <input type="text" id="marquee-text" placeholder="输入滚动弹幕内容" 
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-colors"
                               required>
                    </div>
                    <button type="submit" 
                            class="py-2 px-4 bg-primary text-white rounded-lg font-medium hover:bg-primary/90 transition-all active:btn-press">
                        保存弹幕设置
                    </button>
                </form>
            </div>

            <!-- 活动设置 -->
            <div class="bg-white rounded-xl shadow-md p-6 mb-8 border border-gray-100">
                <h3 class="text-lg font-bold text-gray-800 mb-4">活动设置</h3>
                <form id="activity-form" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="activity-title-input" class="block text-sm font-medium text-gray-700 mb-1">活动名称</label>
                            <input type="text" id="activity-title-input" placeholder="输入活动名称" 
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-colors"
                                   required>
                        </div>
                        <div>
                            <label for="winner-count" class="block text-sm font-medium text-gray-700 mb-1">中奖人数</label>
                            <input type="number" id="winner-count" min="1" value="3" 
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-colors"
                                   required>
                        </div>
                        <div>
                            <label for="start-time" class="block text-sm font-medium text-gray-700 mb-1">开始时间</label>
                            <input type="datetime-local" id="start-time" 
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-colors"
                                   required>
                        </div>
                        <div>
                            <label for="duration-select" class="block text-sm font-medium text-gray-700 mb-1">活动时长</label>
                            <select id="duration-select" 
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-colors"
                                    required>
                                <option value="30">30分钟</option>
                                <option value="60" selected>1小时</option>
                                <option value="120">2小时</option>
                                <option value="240">4小时</option>
                                <option value="720">12小时</option>
                                <option value="1440">1天</option>
                                <option value="2880">2天</option>
                                <option value="10080">1周</option>
                                <option value="custom">自定义分钟</option>
                            </select>
                        </div>
                        <div id="custom-duration-container" class="hidden md:col-span-2">
                            <label for="custom-duration" class="block text-sm font-medium text-gray-700 mb-1">自定义时长（分钟）</label>
                            <input type="number" id="custom-duration" min="1" value="60" 
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-colors">
                        </div>
                    </div>
                    <div>
                        <label for="admin-password-set" class="block text-sm font-medium text-gray-700 mb-1">管理员密码（首次设置或修改）</label>
                        <input type="password" id="admin-password-set" placeholder="设置管理员密码" 
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-colors">
                    </div>
                    <button type="submit" 
                            class="py-2.5 px-6 bg-primary text-white rounded-lg font-medium hover:bg-primary/90 transition-all active:btn-press">
                        保存活动设置
                    </button>
                </form>
            </div>

            <!-- 活动控制 -->
            <div class="bg-white rounded-xl shadow-md p-6 mb-8 border border-gray-100">
                <h3 class="text-lg font-bold text-gray-800 mb-4">活动控制</h3>
                <div class="flex flex-wrap gap-3">
                    <button id="end-activity" 
                            class="py-2.5 px-6 bg-danger text-white rounded-lg font-medium hover:bg-danger/90 transition-all active:btn-press">
                        <i class="fa fa-stop mr-1"></i>结束活动
                    </button>
                    <button id="new-activity" 
                            class="py-2.5 px-6 bg-accent text-white rounded-lg font-medium hover:bg-accent/90 transition-all active:btn-press">
                        <i class="fa fa-refresh mr-1"></i>新建活动
                    </button>
                    <button id="copy-link" 
                            class="py-2.5 px-6 bg-gray-100 text-gray-800 rounded-lg font-medium hover:bg-gray-200 transition-all active:btn-press">
                        <i class="fa fa-link mr-1"></i>复制参与链接（本网站）
                    </button>
                </div>
            </div>

            <!-- 参与者列表 -->
            <div class="bg-white rounded-xl shadow-md p-6 mb-8 border border-gray-100">
                <h3 class="text-lg font-bold text-gray-800 mb-4">参与者列表 (<span id="admin-participant-count">0</span>)</h3>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead>
                            <tr>
                                <th class="px-4 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">序号</th>
                                <th class="px-4 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">小黑盒ID</th>
                                <th class="px-4 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">IP地址</th>
                                <th class="px-4 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">参与时间</th>
                            </tr>
                        </thead>
                        <tbody id="participants-list" class="divide-y divide-gray-200">
                            <tr>
                                <td colspan="4" class="px-4 py-8 text-center text-gray-500">暂无参与者</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- 中奖名单 -->
            <div class="bg-white rounded-xl shadow-md p-6 mb-8 border border-gray-100">
                <h3 class="text-lg font-bold text-gray-800 mb-4">中奖名单</h3>
                <div id="winners-list" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="col-span-full text-center text-gray-500 py-8">
                        活动尚未结束或未抽奖
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- 中奖名单模态框 -->
    <div id="winners-modal" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-xl p-6 max-w-2xl w-full max-h-[80vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-800">本期中奖名单</h3>
                <button id="close-winners-modal" class="text-gray-500 hover:text-gray-700">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            <div id="public-winners-list" class="space-y-4">
                <div class="text-center text-gray-500 py-8">
                    暂无中奖信息
                </div>
            </div>
        </div>
    </div>

    <script>
        // Supabase配置
        const supabaseUrl = 'https://ordrnmjohtxjrwnigzml.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9yZHJubWpvaHR4anJ3bmlnem1sIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUyNTc2MDEsImV4cCI6MjA3MDgzMzYwMX0.OIvCWtQ3l3A3wSq8onLec3J_KG9KPRK8lJs7snqfhKE';
        
        // 初始化Supabase客户端
        let supabase;
        try {
            supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
        } catch (error) {
            showError("Supabase初始化失败，请检查配置信息");
        }

        // 全局数据
        let globalData = {
            activity: {
                id: 'default',
                title: "小羊抽奖活动",
                startTime: new Date().toISOString(),
                endTime: new Date(Date.now() + 3600000).toISOString(), // 默认1小时后结束
                duration: 60, // 活动时长(分钟)
                winnerCount: 3,
                status: "pending", // pending: 未开始, active: 进行中, ended: 已结束
                password: "" // 管理员密码哈希
            },
            marqueeText: "欢迎参与小羊抽奖活动！祝大家好运连连，大奖不断！", // 弹幕内容
            historyActivity: null, // 上一期活动
            historyWinners: [], // 上一期活动中奖名单
            participants: [],
            winners: [],
            isAdmin: false,
            userIp: "",
            subscriptions: [], // 存储实时订阅
            isSubmitting: false, // 标记是否正在提交中
            isAutoDrawing: false // 标记是否正在自动抽奖中
        };
        // 新增：标准化时间处理函数
function normalizeDateTime(input) {
    // 处理datetime-local输入（无时区信息）
    if (input.includes('T') && !input.endsWith('Z')) {
        const date = new Date(input);
        const offset = date.getTimezoneOffset() * 60000;
        return new Date(date.getTime() - offset).toISOString();
    }
    return new Date(input).toISOString();
}

// 新增：本地时间显示格式化
function formatLocalTime(isoString) {
    const date = new Date(isoString);
    // 转换为本地时间字符串（去掉秒和时区信息）
    return date.toLocaleString('zh-CN', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        hour12: false
    }).replace(/\//g, '-');
}
        // 生成UUID函数
        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0;
                const v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }
        // 新增：标准化时间处理函数
        function normalizeDateTime(input) {
        // 处理datetime-local输入（无时区信息）
        if (input.includes('T') && !input.endsWith('Z')) {
        // 添加当前时区偏移
        const date = new Date(input);
        const offset = date.getTimezoneOffset() * 60000;
        return new Date(date.getTime() - offset).toISOString();
    }
    return new Date(input).toISOString();
}

        // 新增：本地时间显示格式化
    function formatLocalTime(isoString) {
        const date = new Date(isoString);
        // 转换为本地时间字符串（去掉秒和时区信息）
        return date.toLocaleString('zh-CN', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        hour12: false
    }).replace(/\//g, '-').replace(/\b(\d)\b/g, '0$1');
        const pad = num => num.toString().padStart(2, '0');
  return `${date.getFullYear()}-${pad(date.getMonth()+1)}-${pad(date.getDate())} ${pad(date.getHours())}:${pad(date.getMinutes())}`;
}
        // 显示错误信息
        function showError(message) {
            document.getElementById("loader").classList.add("hidden");
            document.getElementById("app").classList.add("hidden");
            document.getElementById("error-container").classList.remove("hidden");
            document.getElementById("error-message").textContent = message;
        }

        // 更新加载状态文本
        function updateLoaderText(text) {
            document.getElementById("loader-text").textContent = text;
        }

        // 初始化应用
        async function initApp() {
            try {
                if (!supabase) {
                    throw new Error("Supabase客户端未初始化");
                }
                
                updateLoaderText("正在检查数据库连接...");
                
                // 检查Supabase连接
                const { error: connectionError } = await supabase.from('activity').select('count', { count: 'exact', head: true });
                if (connectionError) {
                    if (connectionError.code === 'PGRST116') {
                        showError(`数据库表不存在，请先在Supabase中执行创建表的SQL脚本。错误详情：${connectionError.message}`);
                        return;
                    } else {
                        throw new Error(`数据库连接失败: ${connectionError.message}`);
                    }
                }
                
                // 创建marquee表（如果不存在）
                await createMarqueeTable();
                
                updateLoaderText("正在获取用户信息...");
                // 获取用户IP（用于防重复参与）
                await getUserIp();
                
                updateLoaderText("正在加载弹幕内容...");
                // 加载弹幕内容
                await loadMarqueeText();
                
                updateLoaderText("正在加载活动数据...");
                // 加载当前活动数据
                await loadActivityData();
                
                // 加载历史活动数据（如果有）
                if (globalData.activity.status === "ended") {
                    await loadLatestHistoryActivity();
                }
                
                updateLoaderText("正在加载参与者...");
                await loadParticipants();
                
                updateLoaderText("正在加载中奖信息...");
                await loadWinners();
                
                // 如果有历史活动，加载其获奖名单
                if (globalData.historyActivity) {
                    await loadHistoryWinners();
                }
                
                updateLoaderText("正在设置实时同步...");
                // 设置实时订阅
                setupRealtimeSubscriptions();
                
                // 检查是否需要自动抽奖（活动已结束但未抽奖）
                checkAndAutoDraw();
                
                // 手动刷新UI状态
                updateActivityDisplay();
                
                updateLoaderText("准备就绪...");
                // 隐藏加载动画，显示应用
                setTimeout(() => {
                    document.getElementById("loader").classList.add("hidden");
                    document.getElementById("app").classList.remove("hidden");
                }, 500);
                
            } catch (error) {
                console.error("初始化错误:", error);
                showError(error.message || "初始化失败，请检查网络连接和配置");
            }
        }

        // 创建marquee表（存储弹幕内容）
        async function createMarqueeTable() {
            const { error } = await supabase.rpc('create_marquee_table_if_not_exists');
            
            // 如果函数不存在，直接创建表
            if (error && error.code === 'PGRST116') {
                const createTableQuery = `
                CREATE TABLE IF NOT EXISTS marquee (
                    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
                    content TEXT NOT NULL,
                    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
                );
                
                -- 插入默认数据（如果表为空）
                INSERT INTO marquee (content)
                SELECT '欢迎参与小羊抽奖活动！祝大家好运连连，大奖不断！'
                WHERE NOT EXISTS (SELECT 1 FROM marquee);
                `;
                
                const { error: createError } = await supabase.rpc('exec_sql', { sql: createTableQuery });
                if (createError) console.warn("创建marquee表失败，使用默认弹幕:", createError);
            }
        }

        // 加载弹幕内容
        async function loadMarqueeText() {
            try {
                const { data, error } = await supabase
                    .from('marquee')
                    .select('content')
                    .order('updated_at', { ascending: false })
                    .limit(1)
                    .single();
                    
                if (error) {
                    console.warn("加载弹幕失败，使用默认内容:", error);
                    return;
                }
                
                if (data?.content) {
                    globalData.marqueeText = data.content;
                    document.getElementById("marquee-content").textContent = data.content;
                    document.getElementById("marquee-text").value = data.content;
                }
            } catch (error) {
                console.error("加载弹幕内容错误:", error);
            }
        }

        // 保存弹幕内容
        async function saveMarqueeText(text) {
            try {
                // 先检查是否有现有记录
                const { data: existingData } = await supabase
                    .from('marquee')
                    .select('id')
                    .order('updated_at', { ascending: false })
                    .limit(1)
                    .single();
                    
                let error;
                
                if (existingData?.id) {
                    // 更新现有记录
                    ({ error } = await supabase
                        .from('marquee')
                        .update({ content: text, updated_at: new Date().toISOString() })
                        .eq('id', existingData.id));
                } else {
                    // 创建新记录
                    ({ error } = await supabase
                        .from('marquee')
                        .insert([{ content: text }]));
                }
                
                if (error) throw error;
                
                // 更新本地数据和UI
                globalData.marqueeText = text;
                document.getElementById("marquee-content").textContent = text;
                return true;
            } catch (error) {
                console.error("保存弹幕内容错误:", error);
                return false;
            }
        }

        // 获取用户IP
        function getUserIp() {
            return new Promise((resolve) => {
                // 尝试从本地存储获取
                const savedIp = localStorage.getItem("lottery_user_ip");
                if (savedIp) {
                    globalData.userIp = savedIp;
                    resolve();
                    return;
                }
                
                // 从API获取，失败时使用临时ID
                fetch("https://api.ipify.org?format=json")
                    .then(response => response.json().catch(() => null))
                    .then(data => {
                        if (data?.ip) {
                            globalData.userIp = data.ip;
                            localStorage.setItem("lottery_user_ip", data.ip);
                        } else {
                            // 失败时生成临时ID
                            const tempId = "temp_" + Math.random().toString(36).substr(2, 9);
                            globalData.userIp = tempId;
                            localStorage.setItem("lottery_user_ip", tempId);
                        }
                        resolve();
                    })
                    .catch(() => {
                        // 网络错误时生成临时ID
                        const tempId = "temp_" + Math.random().toString(36).substr(2, 9);
                        globalData.userIp = tempId;
                        localStorage.setItem("lottery_user_ip", tempId);
                        resolve();
                    });
            });
        }

        // 加载活动数据
        async function loadActivityData() {
            try {
                const { data, error } = await supabase
                    .from('activity')
                    .select('*')
                    .eq('is_current', true)
                    .single();
                    
                if (error) {
                    if (error.code === 'PGRST116') {
                        // 没有当前活动，创建一个新的
                        const newId = generateUUID();
                        const now = new Date();
                        const endTime = new Date(now.getTime() + 3600000); // 1小时后结束
                        
                        const { error: insertError } = await supabase
                            .from('activity')
                            .insert([{
                                id: newId,
                                title: "小羊抽奖活动",
                                start_time: now.toISOString(),
                                end_time: endTime.toISOString(),
                                winner_count: 3,
                                status: "pending",
                                password: "",
                                is_current: true,
                                duration: 60 // 添加时长字段
                            }]);
                            
                        if (insertError) throw insertError;
                        
                        // 重新获取数据
                        return loadActivityData();
                    } else {
                        throw error;
                    }
                } else {
                    // 计算活动时长（分钟）
                    const duration = Math.round(
                        (new Date(data.end_time).getTime() - new Date(data.start_time).getTime()) / (1000 * 60)
                    );
                    
                    // 映射蛇形命名字段到驼峰变量
                    globalData.activity = {
                        id: data.id,
                        title: data.title,
                        startTime: data.start_time,
                        endTime: data.end_time,
                        duration: data.duration || duration, // 使用存储的时长或计算值
                        winnerCount: data.winner_count,
                        status: data.status,
                        password: data.password,
                        isCurrent: data.is_current
                    };
                    
                    // 更新活动设置表单中的时长选择
                    updateDurationSelection();
                }
                
                updateActivityDisplay();
                // 确保结束时间正确（新增验证）
        if (data.end_time) {
            // 如果数据库中有正确的结束时间，直接使用
            globalData.activity.endTime = data.end_time;
        } else {
            // 否则根据开始时间和时长计算
            const start = new Date(data.start_time);
            const end = new Date(start.getTime() + data.duration * 60000);
            globalData.activity.endTime = end.toISOString();
        }
                // 确保duration有默认值
        globalData.activity.duration = data.duration || 
            Math.round((new Date(data.end_time).getTime() - new Date(data.start_time).getTime()) / (1000 * 60));
            } catch (error) {
                console.error("加载活动数据错误:", error);
                throw new Error(`加载活动信息失败: ${error.message}`);
            }
        }

        // 更新时长选择控件
        function updateDurationSelection() {
            const duration = globalData.activity.duration;
            const selectEl = document.getElementById("duration-select");
            const customContainer = document.getElementById("custom-duration-container");
            const customInput = document.getElementById("custom-duration");
            
            // 常用时长选项
            const commonDurations = ["30", "60", "120", "240", "720", "1440", "2880", "10080"];
            
            if (commonDurations.includes(duration.toString())) {
                selectEl.value = duration;
                customContainer.classList.add("hidden");
            } else {
                selectEl.value = "custom";
                customContainer.classList.remove("hidden");
                customInput.value = duration;
            }
        }

        // 加载最新的历史活动（上一期）
        async function loadLatestHistoryActivity() {
            try {
                const { data, error } = await supabase
                    .from('activity')
                    .select('*')
                    .eq('is_current', false)
                    .order('end_time', { ascending: false })
                    .limit(1)
                    .single();
                    
                if (error) {
                    // 没有历史活动，不做处理
                    return;
                }
                
                globalData.historyActivity = {
                    id: data.id,
                    title: data.title,
                    startTime: data.start_time,
                    endTime: data.end_time,
                    winnerCount: data.winner_count,
                    status: data.status
                };
            } catch (error) {
                console.error("加载历史活动错误:", error);
                // 不抛出错误，只是没有历史活动显示
            }
        }

        // 加载参与者数据
        async function loadParticipants() {
            try {
                const { data, error } = await supabase
                    .from('participants')
                    .select('*')
                    .eq('activity_id', globalData.activity.id)
                    .order('time', { ascending: false });
                    
                if (error) throw error;
                
                globalData.participants = data || [];
                updateParticipantsDisplay();
            } catch (error) {
                console.error("加载参与者错误:", error);
                throw new Error(`加载参与者信息失败: ${error.message}`);
            }
        }

        // 检查IP是否已参与
        async function checkIpParticipated(ip) {
            try {
                const { count, error } = await supabase
                    .from('participants')
                    .select('*', { count: 'exact', head: true })
                    .eq('ip', ip)
                    .eq('activity_id', globalData.activity.id);
                    
                if (error) throw error;
                
                return count > 0;
            } catch (error) {
                console.error("检查IP参与状态错误:", error);
                return false;
            }
        }

        // 加载当前活动中奖者数据
        async function loadWinners() {
            try {
                const { data, error } = await supabase
                    .from('winners')
                    .select('*')
                    .eq('activity_id', globalData.activity.id)
                    .order('rank', { ascending: true });
                    
                if (error) throw error;
                
                globalData.winners = data || [];
                updateWinnersDisplay();
            } catch (error) {
                console.error("加载中奖者错误:", error);
                throw new Error(`加载中奖信息失败: ${error.message}`);
            }
        }

        // 加载历史活动中奖者数据
        async function loadHistoryWinners() {
            if (!globalData.historyActivity) return;
            
            try {
                const { data, error } = await supabase
                    .from('winners')
                    .select('*')
                    .eq('activity_id', globalData.historyActivity.id)
                    .order('rank', { ascending: true });
                    
                if (error) throw error;
                
                globalData.historyWinners = data || [];
                updateHistoryWinnersDisplay();
            } catch (error) {
                console.error("加载历史中奖者错误:", error);
                // 不抛出错误，只是没有历史中奖信息显示
            }
        }

        // 设置实时订阅
        function setupRealtimeSubscriptions() {
            // 清除之前的订阅
            globalData.subscriptions.forEach(channel => {
                supabase.removeChannel(channel);
            });
            globalData.subscriptions = [];
            
            try {
                // 订阅活动数据变化
                const activityChannel = supabase
                    .channel('activity-channel')
                    .on(
                        'postgres_changes',
                        { event: '*', schema: 'public', table: 'activity' },
                        async (payload) => {
                            if (payload.new && payload.new.is_current) {
                                // 更新当前活动
                                const duration = Math.round(
                                    (new Date(payload.new.end_time).getTime() - new Date(payload.new.start_time).getTime()) / (1000 * 60)
                                );
                                
                                globalData.activity = {
                                    id: payload.new.id,
                                    title: payload.new.title,
                                    startTime: payload.new.start_time,
                                    endTime: payload.new.end_time,
                                    duration: payload.new.duration || duration,
                                    winnerCount: payload.new.winner_count,
                                    status: payload.new.status,
                                    password: payload.new.password,
                                    isCurrent: payload.new.is_current
                                };
                                
                                updateDurationSelection();
                                updateActivityDisplay();
                                
                                // 如果当前活动已结束，加载历史活动
                                if (globalData.activity.status === "ended") {
                                    await loadLatestHistoryActivity();
                                    if (globalData.historyActivity) {
                                        await loadHistoryWinners();
                                    }
                                }
                                
                                // 检查是否需要自动抽奖
                                checkAndAutoDraw();
                            }
                        }
                    )
                    .subscribe();
                
                globalData.subscriptions.push(activityChannel);
                
                // 订阅参与者数据变化
                const participantsChannel = supabase
                    .channel('participants-channel')
                    .on(
                        'postgres_changes',
                        { event: '*', schema: 'public', table: 'participants', filter: `activity_id=eq.${globalData.activity.id}` },
                        () => {
                            loadParticipants();
                        }
                    )
                    .subscribe();
                
                globalData.subscriptions.push(participantsChannel);
                
                // 订阅中奖者数据变化
                const winnersChannel = supabase
                    .channel('winners-channel')
                    .on(
                        'postgres_changes',
                        { event: '*', schema: 'public', table: 'winners', filter: `activity_id=eq.${globalData.activity.id}` },
                        () => {
                            loadWinners();
                        }
                    )
                    .subscribe();
                
                globalData.subscriptions.push(winnersChannel);
                
                // 订阅弹幕数据变化
                const marqueeChannel = supabase
                    .channel('marquee-channel')
                    .on(
                        'postgres_changes',
                        { event: '*', schema: 'public', table: 'marquee' },
                        () => {
                            loadMarqueeText();
                        }
                    )
                    .subscribe();
                
                globalData.subscriptions.push(marqueeChannel);
            } catch (error) {
                console.error("设置实时订阅错误:", error);
                alert("实时通知功能可能无法使用，数据可能不会自动更新");
            }
        }

        // 更新活动显示
    function updateActivityDisplay() {
        const { title, startTime, endTime, duration, winnerCount, status } = globalData.activity;
    
    // 使用新的格式化函数
    const formattedStart = formatLocalTime(startTime);
    const formattedEnd = formatLocalTime(endTime);
    
    // 新增：基于当前时间判断真实状态
    const now = new Date();
    const start = new Date(startTime);
    const end = new Date(endTime);
    
    // 计算活动时长文本（修复未定义错误）
    let actualStatus = status;
    if (now < start) {
        actualStatus = "pending";
    } else if (now >= start && now <= end) {
        actualStatus = "active";
    } else if (now > end) {
        actualStatus = "ended";
    }
            
            // 更新活动信息显示（使用实际状态）
    document.getElementById("activity-title").textContent = title;
    document.getElementById("activity-time").textContent = 
        `${formattedStart} - ${formattedEnd}`;
    document.getElementById("activity-duration").textContent = 
    `${globalData.activity.duration}分钟`;
    document.getElementById("activity-winners").textContent = 
    globalData.activity.winnerCount;
    document.getElementById("participant-count").textContent = 
    globalData.participants.length;
            // 更新状态标签
    // 使用 actualStatus 替代原来的 status
    const statusEl = document.getElementById("activity-status");
    switch(actualStatus) {
        case "pending":
            statusEl.textContent = "未开始";
            statusEl.className = "inline-block px-4 py-1 rounded-full text-sm font-medium bg-blue-100 text-blue-800";
            break;
        case "active":
            statusEl.textContent = "进行中";
            statusEl.className = "inline-block px-4 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800";
            break;
        case "ended":
            statusEl.textContent = "已结束";
            statusEl.className = "inline-block px-4 py-1 rounded-full text-sm font-medium bg-gray-100 text-gray-800";
            break;
    }
            
            // 控制倒计时显示（只在实际活动进行中显示）
    const countdownEl = document.getElementById("countdown");
    if (actualStatus === "active") {
        countdownEl.classList.remove("hidden");
        startCountdown(end);
    } else {
        countdownEl.classList.add("hidden");
    }
            
            // 控制参与表单显示
            const hasParticipated = globalData.participants.some(p => p.ip === globalData.userIp);
            const formContainer = document.getElementById("participate-form-container");
            const participated提示 = document.getElementById("participated提示");
            const notStarted提示 = document.getElementById("not-started提示");
            const ended提示 = document.getElementById("ended提示");
            
            // 隐藏所有提示
    [formContainer, participated提示, notStarted提示, ended提示].forEach(el => 
        el.classList.add("hidden"));
            
            // 根据实际状态显示对应提示
    if (actualStatus === "active") {
        if (hasParticipated) {
            participated提示.classList.remove("hidden");
        } else {
            formContainer.classList.remove("hidden");
        }
    } else if (actualStatus === "pending") {
        notStarted提示.classList.remove("hidden");
    } else if (actualStatus === "ended") {
        ended提示.classList.remove("hidden");
    }
            
            // 更新管理员表单中的时间和时长
            document.getElementById("activity-title-input").value = title;
            document.getElementById("winner-count").value = winnerCount;
            document.getElementById("start-time").value = formatDateTimeForInput(start);
            
            // 不需要手动设置结束时间，由开始时间和时长自动计算
            
            // 显示历史活动区域（如果有历史活动）
            const historyEl = document.getElementById("history-activity");
            if (globalData.historyActivity && globalData.historyWinners.length > 0) {
                historyEl.classList.remove("hidden");
                updateHistoryWinnersDisplay();
            } else {
                historyEl.classList.add("hidden");
            }
        }

        // 更新历史活动中奖名单显示
        function updateHistoryWinnersDisplay() {
            const historyListEl = document.getElementById("history-winners-list");
            
            if (globalData.historyWinners.length === 0) {
                historyListEl.innerHTML = `
                    <div class="text-center text-gray-500 py-6">
                        暂无历史活动中奖信息
                    </div>
                `;
                return;
            }
            
            historyListEl.innerHTML = globalData.historyWinners.map((winner) => `
                <div class="border border-gray-100 rounded-lg p-4">
                    <div class="flex justify-between items-center mb-2">
                        <span class="font-medium ${
                            winner.rank === 1 ? 'text-yellow-600' : 
                            winner.rank === 2 ? 'text-gray-400' : 
                            winner.rank === 3 ? 'text-amber-700' : 'text-gray-700'
                        }">
                            ${winner.rank}${winner.rank < 4 ? ['等奖', '等奖', '等奖'][winner.rank - 1] : '名'}
                        </span>
                    </div>
                    <div class="text-gray-800">${winner.name}</div>
                </div>
            `).join("");
        }

        // 更新参与者显示
        function updateParticipantsDisplay() {
            const listEl = document.getElementById("participants-list");
            
            if (globalData.participants.length === 0) {
                listEl.innerHTML = `
                    <tr>
                        <td colspan="4" class="px-4 py-8 text-center text-gray-500">暂无参与者</td>
                    </tr>
                `;
                return;
            }
            document.getElementById("participant-count").textContent = 
    globalData.participants.length;
            listEl.innerHTML = globalData.participants.map((p, index) => `
                <tr class="hover:bg-gray-50">
                    <td class="px-4 py-3">${index + 1}</td>
                    <td class="px-4 py-3">${p.name}</td>
                    <td class="px-4 py-3 text-sm text-gray-500">${p.ip}</td>
                    <td class="px-4 py-3 text-sm text-gray-500">${new Date(p.time).toLocaleString()}</td>
                </tr>
            `).join("");
        }

        // 更新中奖者显示
        function updateWinnersDisplay() {
            const adminListEl = document.getElementById("winners-list");
            const publicListEl = document.getElementById("public-winners-list");
            
            if (globalData.winners.length === 0) {
                adminListEl.innerHTML = `
                    <div class="col-span-full text-center text-gray-500 py-8">
                        活动尚未结束或未抽奖
                    </div>
                `;
                publicListEl.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        暂无中奖信息
                    </div>
                `;
                return;
            }
            
            // 管理员页面显示
            adminListEl.innerHTML = globalData.winners.map((winner) => `
                <div class="bg-gray-50 p-4 rounded-lg border border-gray-100">
                    <div class="flex justify-between items-start mb-2">
                        <span class="font-medium ${
                            winner.rank === 1 ? 'text-yellow-600' : 
                            winner.rank === 2 ? 'text-gray-400' : 
                            winner.rank === 3 ? 'text-amber-700' : 'text-gray-700'
                        }">
                            ${winner.rank}${winner.rank < 4 ? ['等奖', '等奖', '等奖'][winner.rank - 1] : '名'}
                        </span>
                        <span class="text-xs text-gray-500">
                            ${new Date(winner.time).toLocaleString()}
                        </span>
                    </div>
                    <div class="text-gray-800 font-medium">${winner.name}</div>
                </div>
            `).join("");
            
            // 公共页面显示
            publicListEl.innerHTML = globalData.winners.map((winner) => `
                <div class="border border-gray-100 rounded-lg p-4">
                    <div class="flex justify-between items-center mb-2">
                        <span class="font-medium ${
                            winner.rank === 1 ? 'text-yellow-600' : 
                            winner.rank === 2 ? 'text-gray-400' : 
                            winner.rank === 3 ? 'text-amber-700' : 'text-gray-700'
                        }">
                            ${winner.rank}${winner.rank < 4 ? ['等奖', '等奖', '等奖'][winner.rank - 1] : '名'}
                        </span>
                    </div>
                    <div class="text-gray-800">${winner.name}</div>
                </div>
            `).join("");
        }

        // 启动倒计时
        function startCountdown(endTime) {
            // 清除之前的定时器
            if (window.countdownTimer) {
                clearInterval(window.countdownTimer);
            }
            
            function updateCountdown() {
                const now = new Date().getTime();
                const distance = new Date(endTime).getTime() - now;
                
                if (distance <= 0) {
                    // 时间到，自动结束活动
                    if (globalData.activity.status === "active") {
                        updateActivityStatus("ended");
                    }
                    clearInterval(window.countdownTimer);
                    return;
                }
                
                const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((distance % (1000 * 60)) / 1000);
                
                document.getElementById("days").textContent = days.toString().padStart(2, "0");
                document.getElementById("hours").textContent = hours.toString().padStart(2, "0");
                document.getElementById("minutes").textContent = minutes.toString().padStart(2, "0");
                document.getElementById("seconds").textContent = seconds.toString().padStart(2, "0");
            }
            
            // 立即更新一次
            updateCountdown();
            // 每秒更新一次
            window.countdownTimer = setInterval(updateCountdown, 1000);
        }

        // 更新活动状态
        async function updateActivityStatus(status) {
    try {
        const updates = { status };
        
        // 只有当活动从pending变为active时，才检查是否需要调整时间
        if (status === "active" && globalData.activity.status === "pending") {
            const now = new Date();
            const scheduledStart = new Date(globalData.activity.startTime);
            
            // 如果计划的开始时间在未来，保持原时间；否则调整为现在
            if (scheduledStart > now) {
                updates.start_time = scheduledStart.toISOString();
            } else {
                updates.start_time = now.toISOString();
                // 重新计算结束时间（基于新开始时间+原时长）
                const endTime = new Date(now.getTime() + globalData.activity.duration * 60000);
                updates.end_time = endTime.toISOString();
            }
        }
        
        const { error } = await supabase
            .from('activity')
            .update(updates)
            .eq('id', globalData.activity.id);
            
        if (error) throw error;
        
        // 更新本地数据
        globalData.activity.status = status;
        if (updates.start_time) globalData.activity.startTime = updates.start_time;
        if (updates.end_time) globalData.activity.endTime = updates.end_time;
        
        updateActivityDisplay();
        
        if (status === "ended") {
            await checkAndAutoDraw();
        }
        
        return true;
    } catch (error) {
        console.error("更新状态失败:", error);
        throw error;
    }
            // 如果活动状态变为结束，检查是否需要自动抽奖
                if (status === "ended") {
                    await checkAndAutoDraw();
                }
}
// 新增函数：显示抽奖结果
        function showDrawResult() {
            if (globalData.winners.length > 0) {
                // 显示中奖名单模态框
                document.getElementById("winners-modal").classList.remove("hidden");
                document.getElementById("winners-modal").classList.add("flex");
            } else if (globalData.participants.length === 0) {
                alert("活动已结束，但没有参与者");
            } else {
                alert("活动已结束，但未抽取出中奖者");
            }
        }
        // 检查并执行自动抽奖
        async function checkAndAutoDraw() {
            // 条件：活动已结束 + 没有中奖名单 + 参与人数足够 + 不在抽奖中
            if (globalData.activity.status === "ended" && 
                globalData.winners.length === 0 && 
                globalData.participants.length >= globalData.activity.winnerCount &&
                !globalData.isAutoDrawing) {
                
                globalData.isAutoDrawing = true;
                
                try {
                    // 显示自动抽奖中提示（仅管理员可见）
                    const winnersList = document.getElementById("winners-list");
                    winnersList.innerHTML = `
                        <div class="col-span-full text-center py-12">
                            <div class="w-16 h-16 border-4 border-gray-200 border-t-accent rounded-full animate-spin mx-auto mb-4"></div>
                            <p class="text-gray-600">活动已结束，正在自动抽取幸运用户...</p>
                        </div>
                    `;
                    
                    // 随机抽取获奖者（不重复）
                    const shuffled = [...globalData.participants].sort(() => 0.5 - Math.random());
                    const winners = shuffled.slice(0, globalData.activity.winnerCount);
                    
                    // 添加排名并保存到数据库
                    const winnersWithRank = winners.map((winner, index) => ({
                        id: generateUUID(),
                        activity_id: globalData.activity.id,
                        name: winner.name,
                        ip: winner.ip,
                        time: new Date().toISOString(),
                        rank: index + 1
                    }));
                    
                    // 模拟抽奖过程延迟
                    await new Promise(resolve => setTimeout(resolve, 2000));
                    
                    const { error } = await supabase
                        .from('winners')
                        .insert(winnersWithRank);
                        
                    if (error) {
                        throw new Error(error.message);
                    }
                    
                    // 刷新中奖名单
                    await loadWinners();
                    // 抽奖完成后显示结果
                    showDrawResult();
                } catch (error) {
                    console.error("自动抽奖失败:", error);
                    const winnersList = document.getElementById("winners-list");
                    winnersList.innerHTML = `
                        <div class="col-span-full text-center text-red-500 py-8">
                            <i class="fa fa-exclamation-circle text-2xl mb-2"></i>
                            <p>自动抽奖失败，请稍后手动处理</p>
                        </div>
                    `;
                } finally {
                    globalData.isAutoDrawing = false;
                }
            }
        }

        // 新建活动 - 保存历史活动，创建新活动
        async function createNewActivity() {
            if (!confirm("确定要新建活动吗？当前活动将转为历史活动并保存其获奖名单，新活动将重新开始。")) {
                return;
            }
            
            try {
                // 1. 将当前活动标记为非当前活动
                const { error: updateCurrentError } = await supabase
                    .from('activity')
                    .update({ is_current: false })
                    .eq('id', globalData.activity.id);
                    
                if (updateCurrentError) {
                    throw new Error(updateCurrentError.message);
                }
                
                // 2. 创建新活动
                const newId = generateUUID();
                const now = new Date();
                const duration = parseInt(document.getElementById("duration-select").value === "custom" 
                    ? document.getElementById("custom-duration").value 
                    : document.getElementById("duration-select").value) || 60;
                
                const endTime = new Date(now);
                endTime.setMinutes(now.getMinutes() + duration);
                
                const { error: insertError } = await supabase
                    .from('activity')
                    .insert([{
                        id: newId,
                        title: "新的小羊抽奖活动",
                        start_time: now.toISOString(),
                        end_time: endTime.toISOString(),
                        winner_count: 3,
                        status: "pending",
                        password: globalData.activity.password, // 沿用之前的密码
                        is_current: true,
                        duration: duration // 存储活动时长
                    }]);
                    
                if (insertError) {
                    throw new Error(insertError.message);
                }
                
                // 3. 重新加载所有数据
                await loadActivityData();
                await loadLatestHistoryActivity();
                if (globalData.historyActivity) {
                    await loadHistoryWinners();
                }
                await loadParticipants();
                await loadWinners();
                
                // 4. 重新设置实时订阅
                setupRealtimeSubscriptions();
                
                alert("新活动已创建，上一期活动已保存为历史记录");
            } catch (error) {
                console.error("新建活动失败:", error);
                alert("新建活动失败: " + error.message);
            }
        }

        // 绑定所有事件
        function bindEvents() {
            // 重试按钮
            document.getElementById("retry-btn").addEventListener("click", () => {
                document.getElementById("error-container").classList.add("hidden");
                document.getElementById("loader").classList.remove("hidden");
                initApp();
            });
            
            // 参与表单提交
            document.getElementById("participate-form").addEventListener("submit", async (e) => {
                e.preventDefault();
                
                // 检查是否正在提交中
                if (globalData.isSubmitting) {
                    return;
                }
                
                const blackboxId = document.getElementById("blackbox-id").value.trim();
                const submitBtn = document.getElementById("submit-btn");
                
                if (!blackboxId) {
                    alert("请输入小黑盒ID");
                    return;
                }
                
                // 检查活动状态
                if (globalData.activity.status !== "active") {
                    alert("活动未开始或已结束");
                    return;
                }
                
                try {
                    // 设置提交状态
                    globalData.isSubmitting = true;
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '<i class="fa fa-spinner fa-spin mr-2"></i>提交中...';
                    submitBtn.classList.add("opacity-70", "cursor-not-allowed");
                    
                    // 检查IP是否已参与
                    const hasParticipated = await checkIpParticipated(globalData.userIp);
                    if (hasParticipated) {
                        alert("您已参与过本次活动");
                        return;
                    }
                    
                    // 添加参与者
                    const { error } = await supabase
                        .from('participants')
                        .insert([{
                            id: generateUUID(),
                            activity_id: globalData.activity.id,
                            name: blackboxId,
                            ip: globalData.userIp,
                            time: new Date().toISOString()
                        }]);
                        
                    if (error) {
                        throw new Error(error.message);
                    }
                    
                    alert("参与成功！");
                    document.getElementById("participate-form").reset();
                } catch (error) {
                    alert("参与失败: " + error.message);
                } finally {
                    // 恢复提交状态
                    globalData.isSubmitting = false;
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i class="fa fa-gift mr-2"></i>确认参与';
                    submitBtn.classList.remove("opacity-70", "cursor-not-allowed");
                }
            });
            
            // 管理员入口
            document.getElementById("admin-enter-btn").addEventListener("click", () => {
                document.getElementById("admin-login-modal").classList.remove("hidden");
                document.getElementById("admin-login-modal").classList.add("flex");
            });
            
            // 关闭管理员模态框
            document.getElementById("close-admin-modal").addEventListener("click", () => {
                document.getElementById("admin-login-modal").classList.add("hidden");
                document.getElementById("admin-login-modal").classList.remove("flex");
            });
            
            // 管理员登录
            document.getElementById("admin-login-form").addEventListener("submit", (e) => {
                e.preventDefault();
                
                const password = document.getElementById("admin-password").value;
                const passwordHash = btoa(password); // 简单加密
                
                if (passwordHash === globalData.activity.password || 
                    (globalData.activity.password === "" && password === "admin123")) { // 首次登录默认密码
                    // 登录成功
                    globalData.isAdmin = true;
                    document.getElementById("admin-login-modal").classList.add("hidden");
                    document.getElementById("admin-login-modal").classList.remove("flex");
                    document.getElementById("admin-panel").classList.remove("hidden");
                    
                    // 首次登录且未设置密码，自动设置
                    if (globalData.activity.password === "") {
                        updateAdminPassword(passwordHash);
                    }
                } else {
                    alert("密码错误");
                }
            });
            
            // 管理员登出
            document.getElementById("admin-logout").addEventListener("click", () => {
                globalData.isAdmin = false;
                document.getElementById("admin-panel").classList.add("hidden");
            });
            
            // 弹幕设置提交
            document.getElementById("marquee-form").addEventListener("submit", async (e) => {
                e.preventDefault();
                
                const text = document.getElementById("marquee-text").value.trim();
                if (!text) {
                    alert("请输入弹幕内容");
                    return;
                }
                
                const success = await saveMarqueeText(text);
                if (success) {
                    alert("弹幕设置已保存");
                } else {
                    alert("保存失败，请重试");
                }
            });
            
            // 时长选择变化事件
            document.getElementById("duration-select").addEventListener("change", (e) => {
                const customContainer = document.getElementById("custom-duration-container");
                if (e.target.value === "custom") {
                    customContainer.classList.remove("hidden");
                } else {
                    customContainer.classList.add("hidden");
                }
            });
            
            // 活动设置表单提交
            // 活动设置表单提交
document.getElementById("activity-form").addEventListener("submit", async (e) => {
    e.preventDefault();
    
    try {
        // 1. 获取表单值
        const title = document.getElementById("activity-title-input").value.trim();
        const winnerCount = parseInt(document.getElementById("winner-count").value);
        const startTimeInput = document.getElementById("start-time").value;
        const durationSelect = document.getElementById("duration-select");
        const customDuration = document.getElementById("custom-duration").value;
        
        // 2. 验证输入
        if (!title || isNaN(winnerCount) || !startTimeInput) {
            throw new Error("请填写完整的活动设置");
        }

        // 3. 计算时间（关键修复）
        let durationMinutes;
        if (durationSelect.value === "custom") {
            durationMinutes = parseInt(customDuration);
            if (isNaN(durationMinutes)) throw new Error("请输入有效的自定义时长");
        } else {
            durationMinutes = parseInt(durationSelect.value);
        }
        // 在activity-form的submit事件中，修改时间处理部分：
const startDate = new Date(startTimeInput);
if (isNaN(startDate.getTime())) throw new Error("无效的开始时间");

// 转换为ISO格式（保留本地时间值）
const timeString = `${startTimeInput}:00`;
const normalizedStartTime = new Date(timeString).toISOString();

// 计算结束时间（精确分钟数）
const endDate = new Date(new Date(timeString).getTime() + durationMinutes * 60000);
        // 4. 准备更新数据
        const updates = {
            title,
            start_time: normalizedStartTime, // 使用标准化后的时间
            end_time: endDate.toISOString(),
            winner_count: winnerCount,
            duration: durationMinutes
        };

        // 5. 添加密码更新逻辑
        const newPassword = document.getElementById("admin-password-set").value;
        if (newPassword) {
            updates.password = btoa(newPassword);
        }

        // 6. 显示加载状态
        const submitBtn = e.target.querySelector('button[type="submit"]');
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> 保存中...';

        // 7. 发送更新请求
        const { error } = await supabase
            .from('activity')
            .update(updates)
            .eq('id', globalData.activity.id);

        if (error) throw error;

        // 8. 刷新数据
        await loadActivityData();
        updateActivityDisplay();
        // ▼▼▼ 新增：保存后询问是否发布 ▼▼▼
        const shouldPublish = confirm("活动设置已保存！\n\n是否立即发布活动？\n(选择取消将保持未开始状态)");
        
        if (shouldPublish) {
            // 显示发布中状态
            const publishBtn = document.createElement('div');
            publishBtn.innerHTML = `
                <div class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center">
                    <div class="bg-white p-6 rounded-lg max-w-sm text-center">
                        <div class="w-12 h-12 border-4 border-gray-200 border-t-primary rounded-full animate-spin mx-auto mb-4"></div>
                        <h3 class="text-lg font-medium text-gray-800 mb-2">正在发布活动...</h3>
                    </div>
                </div>
            `;
            document.body.appendChild(publishBtn);
            
            try {
                // 更新状态为进行中
                await updateActivityStatus("active");
                alert("活动已成功发布！");
            } catch (error) {
                alert("发布失败: " + error.message);
            } finally {
                publishBtn.remove();
            }
        } else {
            alert("活动已保存但未发布，您可以在活动控制面板手动发布");
        }
        // ▲▲▲ 新增结束 ▲▲▲
        alert("活动设置已保存");
    } catch (error) {
        console.error("保存失败:", error);
        alert(`保存失败: ${error.message}`);
    } finally {
        const submitBtn = e.target.querySelector('button[type="submit"]');
        if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.innerHTML = '保存活动设置';
        }
    }
});
            
        // 修改结束按钮事件处理
document.getElementById("end-activity").addEventListener("click", async () => {
    const now = new Date();
    const endTime = new Date(globalData.activity.endTime);
    
    // 双重验证：数据库状态和本地时间
    if (globalData.activity.status !== "active" && now < endTime) {
        alert("活动未在进行中或未到结束时间");
        return;
    }
    
    if (!confirm("确定要强制结束活动吗？")) {
        return;
    }
    
    try {
        // 显示加载状态
        const btn = document.getElementById("end-activity");
        btn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> 结束中...';
        btn.disabled = true;
        
        // 强制更新结束时间为当前时间
        const { error } = await supabase
            .from('activity')
            .update({ 
                status: "ended",
                end_time: new Date().toISOString() // 强制设置为当前时间
            })
            .eq('id', globalData.activity.id);
            
        if (error) throw error;
        
        // 刷新数据
        await loadActivityData();
        await checkAndAutoDraw(); // 触发自动抽奖
        
        // 显示抽奖结果
        showDrawResult();
        
    } catch (error) {
        console.error("结束活动失败:", error);
        alert(`结束失败: ${error.message}`);
    } finally {
        const btn = document.getElementById("end-activity");
        btn.innerHTML = '<i class="fa fa-stop mr-1"></i>结束活动';
        btn.disabled = false;
    }
});
            
            // 新建活动按钮
            document.getElementById("new-activity").addEventListener("click", createNewActivity);
            
            // 复制参与链接
            document.getElementById("copy-link").addEventListener("click", () => {
                const link = window.location.href;
                navigator.clipboard.writeText(link)
                    .then(() => alert("链接已复制"))
                    .catch(() => {
                        prompt("请复制链接", link);
                    });
            });
            
            // 查看中奖名单
            document.getElementById("show-winners-btn").addEventListener("click", () => {
                // 显示前强制刷新中奖名单，确保是最新数据
                loadWinners().then(() => {
                    document.getElementById("winners-modal").classList.remove("hidden");
                    document.getElementById("winners-modal").classList.add("flex");
                });
            });
            
            // 关闭中奖名单模态框
            document.getElementById("close-winners-modal").addEventListener("click", () => {
                document.getElementById("winners-modal").classList.add("hidden");
                document.getElementById("winners-modal").classList.remove("flex");
            });
        }

        // 更新管理员密码
        async function updateAdminPassword(passwordHash) {
            try {
                const { error } = await supabase
                    .from('activity')
                    .update({ password: passwordHash })
                    .eq('id', globalData.activity.id);
                    
                if (error) {
                    throw new Error(error.message);
                }
            } catch (error) {
                console.error("更新密码失败: ", error);
                alert("更新管理员密码失败，请手动设置");
            }
        }

        // 强化formatDateTimeForInput函数
function formatDateTimeForInput(date) {
    const d = new Date(date);
    if (isNaN(d.getTime())) return '';
    
    // 处理时区偏移（兼容所有浏览器）
    const pad = num => num.toString().padStart(2, '0');
    const year = d.getFullYear();
    const month = pad(d.getMonth() + 1);
    const day = pad(d.getDate());
    const hours = pad(d.getHours());
    const minutes = pad(d.getMinutes());
    
    return `${year}-${month}-${day}T${hours}:${minutes}`;
}

        // 页面加载完成后初始化
        window.addEventListener("DOMContentLoaded", () => {
            // 绑定事件
            bindEvents();
            // 初始化应用
            initApp();
        });

        // 页面关闭时清理
        window.addEventListener("beforeunload", () => {
            // 清除定时器
            if (window.countdownTimer) {
                clearInterval(window.countdownTimer);
            }
            
            // 清除订阅
            globalData.subscriptions.forEach(channel => {
                if (supabase) {
                    supabase.removeChannel(channel);
                }
            });
        });
    </script>
</body>
</html>
    



















